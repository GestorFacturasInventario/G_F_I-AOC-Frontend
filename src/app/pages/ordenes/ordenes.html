<div class="ordenes-container">

  <!-- Mensaje de notificación -->
  <div *ngIf="mensaje" class="mensaje" [ngClass]="{'mensaje-success': tipoMensaje === 'success', 'mensaje-error': tipoMensaje === 'error'}">
    {{ mensaje }}
  </div>

  <!-- Panel de Filtros -->
  <div class="filtros-panel">
    <div class="filtros-header">
      <button 
        type="button" 
        class="btn btn-filtro"
        (click)="toggleFiltros()"
        [ngClass]="{'activo': mostrarFiltros || filtrosActivos}"
      >
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
        Filtros
        <span *ngIf="filtrosActivos" class="badge-filtros">●</span>
      </button>
      
      <button 
        type="button" 
        class="btn btn-limpiar"
        (click)="limpiarFiltros()"
        *ngIf="filtrosActivos"
        title="Limpiar filtros"
      >
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="filtros-contenido" *ngIf="mostrarFiltros">
      <div class="filtros-grid">
        <!-- Filtro Estado -->
        <div class="filtro-item">
          <label for="filtroEstado">Estado</label>
          <select 
            id="filtroEstado" 
            [(ngModel)]="filtroEstado" 
            (ngModelChange)="aplicarFiltros()"
            name="filtroEstado"
          >
            <option value="">Todos</option>
            <option value="pendiente">Pendiente</option>
            <option value="liquidado">Liquidado</option>
          </select>
        </div>

        <!-- Filtro Año -->
        <div class="filtro-item">
          <label for="filtroAnio">Año</label>
          <select 
            id="filtroAnio" 
            [(ngModel)]="filtroAnio" 
            (ngModelChange)="aplicarFiltros()"
            name="filtroAnio"
          >
            <option [ngValue]="null">Todos</option>
            <option *ngFor="let anio of aniosDisponibles" [ngValue]="anio">{{ anio }}</option>
          </select>
        </div>

        <!-- Filtro Mes -->
        <div class="filtro-item">
          <label for="filtroMes">Mes</label>
          <select 
            id="filtroMes" 
            [(ngModel)]="filtroMes" 
            (ngModelChange)="aplicarFiltros()"
            name="filtroMes"
            [disabled]="!filtroAnio"
          >
            <option [ngValue]="null">Todos</option>
            <option *ngFor="let mes of meses" [ngValue]="mes.valor">{{ mes.nombre }}</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Header con contador -->
  <div class="lista-header">
    <h3>
      Lista de Órdenes de Compra
      <span class="badge">{{ ordenesFiltradas.length }}</span>
      <span *ngIf="ordenesFiltradas.length !== ordenes.length" class="filtrado-info">
        (filtradas de {{ ordenes.length }})
      </span>
    </h3>
  </div>
  
  <!-- Cargando -->
  <div *ngIf="cargando && ordenes.length === 0" class="cargando">
    <div class="spinner"></div>
    Cargando órdenes...
  </div>

  <!-- Sin datos -->
  <div *ngIf="!cargando && ordenes.length === 0" class="sin-datos">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>
    <p>No hay órdenes de compra</p>
    <small>Las órdenes se generan desde cotizaciones aprobadas</small>
  </div>

  <!-- Sin resultados de búsqueda/filtros -->
  <div *ngIf="!cargando && ordenes.length > 0 && ordenesFiltradas.length === 0" class="sin-datos">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
    </svg>
    <p>No se encontraron órdenes</p>
    <small>Intenta con otro término o ajusta los filtros</small>
  </div>

  <!-- Grid de Órdenes -->
  <div class="ordenes-grid" *ngIf="ordenesFiltradas.length > 0">
    <div 
      *ngFor="let orden of ordenesFiltradas; trackBy: trackByOrdenId" 
      class="orden-card"
      [ngClass]="'orden-' + orden.estado_ord"
    >
      <!-- Header con referencia y estado -->
      <div class="orden-header">
        <div class="orden-numero">
          <strong>{{ orden.referencia_ord }}</strong>
          <span 
            class="badge badge-estado" 
            [ngClass]="'badge-' + orden.estado_ord"
          >
            {{ orden.estado_ord }}
          </span>
        </div>
      </div>

      <!-- Información de la cotización origen -->
      <div class="orden-cotizacion">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
        </svg>
        <span>
          <strong>Cotización:</strong> {{ orden.cotizacion_id?.numero_cot }} • 
          <strong>Cliente:</strong> {{ orden.cotizacion_id?.cliente }}
        </span>
      </div>

      <!-- Descripción -->
      <div class="orden-descripcion">
        {{ orden.descripcion_ord }}
      </div>

      <!-- Empleado responsable -->
      <div class="orden-empleado">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        <span>{{ orden.empleado }}</span>
      </div>

      <!-- Monto total -->
      <div class="orden-monto">
        <span class="monto-label">Total:</span>
        <span class="monto-valor">{{ orden.total | currency:'MXN':'symbol':'1.2-2' }}</span>
      </div>

      <!-- Acciones -->
      <div class="orden-acciones">
        <div class="acciones-izquierda">
          <button
            class="btn btn-download"
            (click)="descargarArchivo(orden); $event.stopPropagation()"
            [disabled]="cargando"
            title="Descargar archivo"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
          </button>

          <button 
            *ngIf="puedeGenerarFactura(orden)"
            class="btn btn-factura"
            (click)="abrirFormularioFactura(orden, $event)"
            [disabled]="cargando"
            title="Generar Factura"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Generar Factura
          </button>

          <button 
            class="btn btn-editar"
            (click)="abrirFormularioEdicion(orden); $event.stopPropagation()"
            [disabled]="cargando"
            title="Editar orden"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Editar
          </button>

          <button class="btn btn-facturasOrden"
            (click)="verFacturas(orden)">
            Ver Facturas
          </button>
        </div>

        <button 
          class="btn btn-eliminar"
          (click)="eliminarOrden(orden, $event)"
          [disabled]="cargando"
          title="Eliminar orden"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      </div>
    </div>
  </div>
  <div *ngIf="mostrarFormularioEdicion" class="modal-overlay" (click)="cerrarFormularioEdicion()">
    <div class="modal-contenido" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Editar Orden de Compra</h3>
        <button class="btn-close" (click)="cerrarFormularioEdicion()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
  
      <div class="modal-body">
        <p class="orden-seleccionada-info">
          Orden: <strong>{{ ordenSeleccionada?.referencia_ord }}</strong>
        </p>
  
        <form (ngSubmit)="actualizarOrden()">
          <div class="form-group">
            <label for="descripcion_ord">Descripción *</label>
            <textarea 
              id="descripcion_ord" 
              [(ngModel)]="datosEdicion.descripcion_ord" 
              name="descripcion_ord"
              rows="3"
              required
            ></textarea>
          </div>
  
          <div class="form-group">
            <label for="empleado">Empleado Responsable *</label>
            <input 
              type="text" 
              id="empleado" 
              [(ngModel)]="datosEdicion.empleado" 
              name="empleado"
              placeholder="Nombre del empleado"
              required
            />
          </div>
          
          <div class="form-group">
            <label for="archivo_ord">Archivo *</label>
            <input 
              type="file" 
              id="archivo_ord" 
              (change)="onArchivoSeleccionado($event, 'orden')"
              accept=".pdf,.doc,.docx,.xls,.xlsx"
              [disabled]="cargando"
            />
            <small *ngIf="nombreArchivo" class="archivo-info">
              seleccionado: {{ nombreArchivo }}
            </small>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="fecha_limite">Fecha Límite *</label>
              <input 
                type="date" 
                id="fecha_limite" 
                [(ngModel)]="datosEdicion.fecha_limite" 
                name="fecha_limite"
                [min]="fechaMinima"
                required
              />
            </div>
  
            <div class="form-group">
              <label for="descuento">Descuento (%)</label>
              <input 
                type="number" 
                id="descuento" 
                [(ngModel)]="datosEdicion.descuento" 
                name="descuento"
                placeholder="0"
                min="0"
                max="99"
                step="0.01"
              />
            </div>
          </div>
  
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="cerrarFormularioEdicion()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="cargando">
              {{ cargando ? 'Actualizando...' : 'Actualizar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Modal para la generacion de facturas -->
  <div *ngIf="mostrarFormularioFactura" class="modal-overlay" (click)="cerrarFormularioFactura()">
    <div class="modal-contenido" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Generar Factura</h3>
        <button class="btn-close" (click)="cerrarFormularioFactura()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
  
      <div class="modal-body">
        <p class="orden-seleccionada-info">
          Orden: <strong>{{ ordenParaFactura?.referencia_ord }}</strong>
          <br>
          Total pendiente: <strong>{{ ordenParaFactura?.total | currency:'MXN':'symbol':'1.2-2' }}</strong>
        </p>

        <form (ngSubmit)="generarFactura()">
          <div class="form-group">
            <label for="numero_fac">Número de Factura *</label>
            <input 
              type="text" 
              id="numero_fac" 
              [(ngModel)]="datosFactura.numero_fac" 
              name="numero_fac"
              placeholder="FAC-2024-001"
              required
            />
          </div>

          <div class="form-group">
            <label for="concepto">Concepto *</label>
            <textarea 
              id="concepto" 
              [(ngModel)]="datosFactura.concepto" 
              name="concepto"
              placeholder="Descripción del pago o concepto"
              rows="3"
              required
            ></textarea>
          </div>

          <div class="form-group">
            <label for="cantidad">Cantidad a pagar *</label>
            <input 
              type="number" 
              id="cantidad" 
              [(ngModel)]="datosFactura.cantidad" 
              name="
              ]]]cantidad"
              placeholder="0.00"
              step="0.01"
              min="0.01"
              max="ordenParaFactura?.total"
              required
            />
            <small class="help-text">
              Máximo: {{ ordenParaFactura?.total | currency:'MXN':'symbol':'1.2-2' }}
            </small>
          </div>
          
          <div class="form-group">
            <label for="archivo_fac">Archivo</label>
            <input 
              type="file"
              id="archivo_fac"
              (change)="onArchivoSeleccionado($event, 'factura')"
              accept=".pdf,.doc,.docx,.xls,.xlsx"
              [disabled]="cargando"
            />
            <small *ngIf="nombreArchivo" class="archivo-info">
              seleccionado: {{ nombreArchivo }}
            </small>
          </div>
          
          <div class="info-restante" *ngIf="datosFactura.cantidad > 0">
            <p>
              <strong>Restante después de esta factura:</strong>
              {{ (ordenParaFactura?.total || 0) - datosFactura.cantidad | currency:'MXN':'symbol':'1.2-2' }}
            </p>
            <p *ngIf="ordenParaFactura?.total === datosFactura.cantidad" class="liquidado-msg">
              Esta factura liquidará completamente la orden
            </p>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="cerrarFormularioFactura()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="cargando">
              {{ cargando ? 'Generando...' : 'Generar Factura' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Modal para ver facturas de la orden -->
  <div *ngIf="mostrarFacturas" class="modal-overlay" (click)="cerrarFacturas()">
    <div class="modal-contenido" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Facturas de la Orden</h3>
        <button class="btn-close" (click)="cerrarFacturas()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div *ngIf="facturas.length > 0; else noFacturas">
          <div class="facturas-grid">
            <div *ngFor="let fac of facturas" class="factura-card">
              <div class="factura-header">
                <span class="factura-numero">{{ fac.numero_fac }}</span>
                <span class="factura-badge">{{ fac.cantidad | currency:'MXN':'symbol':'1.2-2' }}</span>
              </div>
              
              <div class="factura-concepto">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span>{{ fac.concepto }}</span>
              </div>

              <div class="factura-fecha" *ngIf="fac.createdAt">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span>{{ fac.createdAt | date:'dd/MM/yyyy' }}</span>
              </div>

              <button 
                class="btn btn-download-factura"
                (click)="descargarArchivoFactura(fac._id)"
                [disabled]="cargando"
                *ngIf="fac.archivo_fac"
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Descargar Archivo
              </button>
            </div>
          </div>
        </div>

        <ng-template #noFacturas>
          <div class="sin-datos-modal">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p>No hay facturas registradas para esta orden.</p>
          </div>
        </ng-template>
      </div>

      <div class="modal-footer-facturas">
        <button class="btn-close-modal" (click)="cerrarFacturas()">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>